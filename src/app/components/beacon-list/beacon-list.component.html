<div class="position-relative">

  <div *ngIf="tree?.beacons?.length !== 0 || modify" class="beacon-toolbar">

    <!-- time range -->
    <div *ngIf="showData" class="d-inline-block">

      <div dropdown class="btn-group">
        <button dropdownToggle type="button" class="btn btn-sm btn-outline-dark dropdown-toggle">
          {{currentBeaconDataMode | translate}}
        </button>
        <div *dropdownMenu class="dropdown-menu dropdown-menu-right">
          <a *ngFor="let mode of BEACON_DATA_MODE_KEYS;" class="dropdown-item" (click)="loadBeaconData(BeaconDataMode[mode]);">{{BeaconDataMode[mode] | translate}}</a>
        </div>
      </div>

    </div>

    <!-- add beacon (modify) -->
    <div *ngIf="modify" class="d-inline-block" [ngClass]="{'ml-2': showData}">

      <button class="btn btn-sm btn-outline-primary d-flex align-items-center" (click)="onAddBeaconClick()">
        <i class="i i-xs i-beacon-info mr-1"></i>
        Add beacon
      </button>

    </div>

  </div>

</div>

<div class="scroll-x">
  <div class="chart-tabs-container">

    <tabset *ngIf="tree?.beacons?.length !== 0">
      <tab *ngFor="let beacon of tree.beacons" [id]="beacon.deviceId" [active]="isTabActive(beacon)">
        <ng-template tabHeading>
          <div class="d-flex justify-content-center align-items-center">
            {{beacon.deviceId}}
            <i class="beacon-status"
               [ngClass]="{'ok': beacon.status === 'OK', 'new': beacon.status === 'INITIAL', 'error': beacon.status === 'LOCKED' || beacon.status === 'INVALID_SETTINGS'}"></i>
          </div>
        </ng-template>

        <div *ngIf="showData && !(beacon.chartData && beacon.datasets?.length > 0)" class="beacon-warning my-4">
          <div class="i mr-2"></div>
          {{'tree.beacon.data.missing' | translate}}
        </div>

        <div *ngIf="showData && beacon.chartData && beacon.datasets?.length > 0" class="line-chart-full">
          <ngx-charts-line-chart
            [scheme]="colorScheme"
            [results]="beacon.chartData"
            [gradient]="true"
            [xAxis]="true"
            [yAxis]="true"
            [legend]="true"
            [legendPosition]="'below'"
            [showXAxisLabel]="false"
            [showYAxisLabel]="false"
            [xAxisLabel]="'tree.beacon.chart.xAxisLabel' | translate"
            [autoScale]="true"
            [roundDomains]="true"
            [maxYAxisTickLength]="2">
          </ngx-charts-line-chart>

        </div>

        <div *ngIf="modify" class="beacon-settings mt-3">

          <table class="table table-striped">
            <tr>
              <td>Device ID</td>
              <td>{{beacon.deviceId}}</td>
            </tr>
            <tr>
              <td>Address</td>
              <td>{{beacon.bluetoothAddress}}</td>
            </tr>
            <tr>
              <td>Status</td>
              <td>
                {{beacon.status}}
                <div *ngIf="beacon.status === 'LOCKED' || beacon.status === 'INVALID_SETTINGS'"
                     class="d-flex align-items-center mt-2 text-sm text-danger">
                  <i class="i i-sm i-special i-warning-danger mr-2"></i>
                  <div *ngIf="beacon.status === 'LOCKED'">
                    This beacon has a PIN that is not equal to the one shown below and can't be accessed.
                  </div>
                  <div *ngIf="beacon.status === 'INVALID_SETTINGS'">
                    This beacon has invalid settings that <b>prevent read-out</b>.
                  </div>
                </div>
              </td>
            </tr>
          </table>

          <div class="mt-3 d-flex justify-content-end">

            <ng-template #removeBeaconConfirm>
              <div class="mb-1">
                Do you really want to remove this beacon?
              </div>
              <div *ngIf="beacon.deleteStatus === StatusValue.FAILED" class="d-flex justify-content-center text-danger mb-1">
                <i class="i i-sm i-warning-danger mr-2"></i>
                Failed to remove
              </div>
              <button *ngIf="beacon.deleteStatus === undefined || beacon.deleteStatus === StatusValue.FAILED"
                      class="btn btn-danger btn-block"
                      (click)="onRemoveBeaconClick(beacon); $event.stopPropagation()">
                Yes, remove
              </button>
              <button *ngIf="beacon.deleteStatus === StatusValue.IN_PROGRESS" class="btn btn-danger btn-block">
                <i class="i i-sm i-spin i-load float-left"></i>
                Removing
              </button>
              <div *ngIf="beacon.deleteStatus === StatusValue.SUCCESSFUL" class="d-flex justify-content-center text-success my-2">
                <i class="i i-sm i-check-success mr-2"></i>
                Successfully removed!
              </div>
            </ng-template>
            <div *ngIf="beacon.logs.length === 0 && beacon.logLoadingStatus === StatusValue.IN_PROGRESS" class="beacon-message text-sm mr-4">
              <i class="i i-sm i-spin i-dark i-load mr-2"></i>
              Loading beacon logs...
            </div>
            <div *ngIf="beacon.logs.length === 0 && beacon.logLoadingStatus === StatusValue.FAILED" class="beacon-warning text-sm mr-4">
              <i class="i i-sm mr-2"></i>
              Could not load beacon logs
            </div>
            <button *ngIf="!beacon.isLogsShown"
                    (click)="beacon.isLogsShown = true; loadBeaconLogsInitial(beacon)"
                    class="btn btn-sm btn-outline-dark d-flex text-center mr-2">
              <i class="i i-xs i-dark i-log mr-1"></i>
              Show logs
            </button>
            <button *ngIf="beacon.isLogsShown"
                    (click)="beacon.isLogsShown = false;"
                    class="btn btn-sm btn-outline-dark d-flex text-center mr-2">
              <i class="i i-xs i-dark i-log mr-1"></i>
              Hide logs
            </button>
            <div dropdown class="btn-group mr-2">
              <button dropdownToggle type="button" class="btn btn-sm btn-outline-dark dropdown-toggle">
                <i class="i i-xs i-dark i-warning mr-1 float-left"></i>
                Log Level: {{selectedMinLogSeverity}}
              </button>
              <div *dropdownMenu class="dropdown-menu dropdown-menu-right">
                <a *ngFor="let severity of BEACON_LOG_SEVERITY;" class="dropdown-item" (click)="setBeaconLogSeverity(BeaconLogSeverity[severity])">
                  {{severity}}
                </a>
              </div>
            </div>
            <button class="btn btn-sm btn-outline-danger d-flex text-center"
                    [ngClass]="{'remove-disabled': beacon.deleteStatus === StatusValue.SUCCESSFUL}"
                    [popover]="removeBeaconConfirm"
                    outsideClick=true>
              <i class="i i-xs i-trash-danger mr-1"></i>
              Remove beacon
            </button>

          </div>

          <div *ngIf="beacon.isLogsShown && beacon.logs.length > 0">

            <hr/>

            <table class="table table-sm table-striped logs mb-0" *ngIf="beacon.logs?.length > 0">
              <tr *ngFor="let log of beacon.logs">
                <td>
                  <div class="log-severity" [ngClass]="'level-' + log.severity | lowercase">{{log.severity}}</div>
                </td>
                <td>
                  {{log.message}}
                </td>
                <td>
                  {{log.eventDate | date:'yyyy-MM-dd HH:mm:ss'}}
                </td>
              </tr>
            </table>

            <div *ngIf="beacon.logLoadingStatus === StatusValue.SUCCESSFUL && beacon.canShowMoreLogs"
                 (click)="loadBeaconLogs(beacon)"
                 class="btn btn-sm btn-block btn-link">
              Load more
            </div>
            <div *ngIf="beacon.logLoadingStatus === StatusValue.SUCCESSFUL && !beacon.canShowMoreLogs"
                 class="text-subtle text-sm text-center my-2">
              All logs loaded
            </div>
            <div *ngIf="beacon.logLoadingStatus === StatusValue.IN_PROGRESS" class="beacon-message text-sm my-2">
              <i class="i i-sm i-spin i-dark i-load mr-2"></i>
              Loading beacon logs...
            </div>
            <div *ngIf="beacon.logLoadingStatus === StatusValue.FAILED"
                 class="beacon-warning text-sm my-2">
              <i class="i i-sm mr-2"></i>
              Could not load more logs
            </div>

          </div>

          <div *ngIf="beacon.logs.length === 0 && !beacon.canShowMoreLogs && beacon.isLogsShown">
            <hr/>
            <div class="beacon-warning my-2">
              <i class="i mr-2"></i>
              No logs found for given log levels
            </div>
          </div>

          <hr/>

          <div *ngIf="hasStatus(StatusKey.BEACON_SETTINGS, StatusValue.IN_PROGRESS)" class="beacon-message my-4">
            <i class="i i-spin i-dark i-load mr-2"></i>
            Loading beacon settings...
          </div>

          <div *ngIf="hasStatus(StatusKey.BEACON_SETTINGS, StatusValue.FAILED)" class="beacon-warning my-4">
            <i class="i mr-2"></i>
            Could not load beacon settings
          </div>

          <div *ngIf="beacon.settings">

            <table class="table table-striped">
              <tr>
                <td>PIN</td>
                <td class="pin">{{beacon.settings.pin}}</td>
              </tr>
              <tr>
                <td>Reference Date</td>
                <td>{{beacon.settings.refTime}} <small>(original device-local date; not UTC)</small></td>
              </tr>
              <tr>
                <td>Battery Level</td>
                <td>
                  {{calcEffectiveBatteryLevel(beacon.settings.batteryLevel)}} %
                  <small>(estimated capacity)</small>
                  <span class="battery-popover-btn ml-2 i i-xs i-dark i-info pointer"
                        [popover]="batteryPopover"
                        outsideClick=true
                        container="body"
                        placement="top"
                  ></span>
                  <ng-template #batteryPopover>
                    Actual percentage received from device: <b>{{beacon.settings.batteryLevel}} %</b>
                    <div class="pt-1 battery-popover-warning-text d-flex justify-content-center align-items-center">
                      <div class="pr-2"><span class="i i-sm i-special i-warning-warning"></span></div>
                      <div>
                        Battery percentage from the device ({{beacon.settings.batteryLevel}} %) is
                        misleading and does not represent the capacity, but <b>voltage</b>.
                      </div>
                    </div>
                  </ng-template>
                </td>
              </tr>
              <tr>
                <td>Firmware version</td>
                <td>{{beacon.settings.firmwareVersionCode}}</td>
              </tr>
              <tr>
                <td>Logging interval</td>
                <td>{{beacon.settings.loggingIntervalSec}} sec</td>
              </tr>
              <tr>
                <td>Sensor interval</td>
                <td>{{beacon.settings.sensorIntervalSec}} sec</td>
              </tr>
              <tr>
                <td>Transmit power</td>
                <td>{{beacon.settings.transmitPowerDb}} db</td>
              </tr>
            </table>

            <div class="text-center text-subtle text-sm">
              <div *ngIf="beacon.status !== 'INITIAL'; else beaconSettingsNotFetched">
                Settings last fetched from device at {{beacon.settings.checkDate}}
              </div>
              <ng-template #beaconSettingsNotFetched>
                Settings are placeholder until they are fetched by the app at least once.
              </ng-template>
            </div>

          </div>

        </div>


      </tab>
    </tabset>

  </div>
</div>

<div *ngIf="tree?.beacons?.length === 0" class="beacon-warning my-4">
  <div class="i mr-2"></div>
  {{'tree.beacon.details.none_attached' | translate}}
</div>
